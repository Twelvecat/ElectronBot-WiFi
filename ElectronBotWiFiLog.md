# ElectronBot-WiFi

暂时使用此页面记录毕业礼物思考、设计与制作的全内容。计划复现 ElectronBot，并根据实际需求进行功能的增删改。

## 关键日志

- 2022.04.28：启动项目，了解项目基本结构
  
- 2022.04.29：发现了一款改进后的结构，可以减少打磨时间；浏览了讨论区和 issue 区的一些问题并做了整理收集；

- 2022.04.30：梳理了固件代码逻辑，底层使用两片固定内存空间来完成指令的收发，内存空间内包含了显示内容与舵机控制指令。针对语音及 WiFi 功能进行了讨论，了解到 ESP32-S3 提供了离线语音支持，表现效果较好，不过官方案例过于复杂，现又发现一款数字 MIC（MSM261S4030H0），可以直连 I2S 进行信号传输。

## 所需思考的问题

- [语音版](https://github.com/jinsonli/ElectronBot-Voice) 相比于 [原版](https://github.com/peng-zhihui/ElectronBot) 有何改动，此改动在软硬件和机械组装上的注意点
    > 以下来自原作者的解释：
    > 1. 只有主板的硬件不一样，其他硬件都一样。
    > 2. 主板上仅将 SD 卡模块更换为了 WM8978 音频模块，其他接口全部兼容。为了后期也能够扩展本地存储功能，增加了 SPI-flash。
    > 3. 如果要使用语音功能，需要使用本项目中的 USB 上层通讯协议。
    > 4. 稚晖君的语音助手项目 pico 里面有一个 USB 声卡芯片，开发会更加简单，我打算也试试这个方案，成功后会第一时间通知大家！
    > 5. 如果有打算学习音频开发的同学可以参考目前的这个硬件。WM8978 是很不错的一款 CODEC，目前国内也出了不少替换的硬件。比如 ES8388 之类的。

- 显示屏如何快速刷新，以实现视频的直接显示
    > 在固件部分，使用 42 MHz 的 SPI 通讯，使用了 DMA 将 USB Buffer 的内容直接由内存刷新到外设。经过计算，240\*240 像素的显示屏可以达到 30 帧的刷新率，而作者只刷新了 60\*240 的像素点刷新，实际上可以达到 120 帧的刷新率。

- 离线模式、手机\平板模式、WiFi 模式的探索
    > 讨论得出三种方式：
    > 1. 麦克风与扬声器通过 USB-HUB 直连电脑，完全作为电脑的配件，不经过 STM32。优点是设计简单，算法部分在电脑上实现，缺点是丧失离线功能。
    > 2. 麦克风与扬声器通过 I2S 直连 STM32。STM32 可以选择性将其传输到电脑或 ESP32/ESP8266，通过 WiFi 可以上传到服务器处理。优点是可以脱离电脑工作，缺点是占用了 STM32 的资源，且数据通信可能需要修改 USB 字节流。
    > 3. 麦克风与扬声器直连 ESP32/ESP8266，完全不占用 STM32 资源。ESP32/ESP8266 通过 SPI3 与 STM32 通讯，模拟电脑端指令，实现视频与舵机的控制。优点是对原工程代码改动较小，缺点是不确定能不能装配成功。

- 似乎没有 Keil 工程，可能需要配置 Clion 的开发环境
    > 需要使用 Clion 打开，可以根据 [此方法](https://zhuanlan.zhihu.com/p/145801160) 配置。

- 有一款 [改进后的结构](https://gitee.com/txp666/ElectronBot_Study
)，可以减少打磨花费的时间

- 部分结构可能厂家无法打印，见 [此处](https://gitee.com/txp666/ElectronBot_Study/tree/main/3D%E6%89%93%E5%8D%B0) 讨论

- [机械加工拆图分享](https://github.com/peng-zhihui/ElectronBot/discussions/54)

- 摄像头驱动问题
    > 摄像头通过 USB-HUB 直连电脑，不经过 STM32。**所以无法在离开电脑的情况下使用摄像头**。
    > 
    > 摄像头的 [购买链接](https://item.taobao.com/item.htm?id=567717780577)
    > 
    > 各传感器之间的关系可以参考 [此处](https://github.com/peng-zhihui/ElectronBot/issues/24)

- 建模步骤，作者分享了 [源文件](https://a360.co/3t6CUMS)

- 据说 [晶振未使能](https://github.com/peng-zhihui/ElectronBot/issues/27)，作者修复，不知情况如何，开发中需要注意
    > 核查完毕，已经重新配置了时钟，启用了外部晶振。

- 手势识别芯片
    > 手势模式，主要识别功能是靠摄像头实现的，PAJ7620U2 只能识别若干很简单的手势
    >
    > 识别算法部分，作者使用 YOLOv5 做目标检测，类别是自己采集的手势图像进行重训练，推理得到检测结果之后调用 AHK 脚本实现模拟键盘按键的。

- `USBInterface.dll` 的问题
    > 作者自己写的，基于 libusb，这个二次开发不涉及修改所以没有上传。主要功能是 USB 设备管理和底层数据的 Bulk 读写。

- 麦克风的驱动
    > 作者建议使用 USB-HUB，由电脑驱动，不利用 STM32 驱动

- SD卡槽
    > 淘宝搜店铺 **金航通电子商行**

- PCB 打样厚度
    > 选择 1 mm

- 舵机内部与驱动板如何接线
    > 可以参考此 [示意图](https://github.com/peng-zhihui/ElectronBot/issues/100)

- 舵机选取 3.7g 还是 4.3g 的 [讨论](https://github.com/peng-zhihui/ElectronBot/issues/108)

- FPC 排线
    > 需要使用反向排线，[示意图](https://github.com/peng-zhihui/ElectronBot/issues/117)。

- 3D打印是否镜像问题
    > T推杆的头是打印的，推杆本身是一个 M2 的半牙螺丝，尺寸看图；舵机的推杆连接件要镜像

## 关键技术

### 拓展性和开放性

### 高速 USB 

### 舵机改装后的控制

### 语音输入输出

### 脱离USB运行

### 舵机改造

### 上位机开发

使用到了 Unity C#